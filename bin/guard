#!/usr/bin/env ruby

require "pathname"

default = Pathname(ENV.fetch("BUNDLE_GEMFILE", "Gemfile"))
relative_to_binstub = Pathname(__FILE__).realpath + "../../Gemfile"
gemfile = [default, relative_to_binstub].detect(&:exist?)

if gemfile
  ENV["BUNDLE_GEMFILE"] = gemfile.to_s
  require "rubygems"
  require "bundler/setup"
else
  require "rubygems"
end

def ignore_interrupts(*args)
  pid = spawn(*args)
  begin
    Process.wait(pid)
  rescue Interrupt
    retry
  end
end

while !ignore_interrupts(Gem.bin_path("guard", "_guard-core"), *ARGV) && $?.exitstatus == 2
  puts("Restarting guard...")
end
exit($?.exitstatus)
